# CKA特化: ノード管理

## 概要

ノードのメンテナンス、スケジューリング制御はCKA試験の頻出領域。
drain/cordon/uncordon、Taint/Toleration、NodeAffinity を正確に理解する。

---

## 1. ノードのメンテナンス

### コマンド比較

| コマンド | 新規Pod | 既存Pod | 用途 |
|---------|--------|--------|------|
| `cordon` | ブロック | そのまま | スケジュール停止 |
| `drain` | ブロック | 退避 | メンテナンス準備 |
| `uncordon` | 許可 | - | 復帰 |

### 正しい手順（試験頻出）

```bash
# 1. スケジュール停止（新規Podが来ないように）
kubectl cordon <node-name>

# 2. 既存Podを退避
kubectl drain <node-name> --ignore-daemonsets

# 3. メンテナンス作業...

# 4. 復帰
kubectl uncordon <node-name>
```

---

### cordon（スケジュール停止）

```bash
# ノードをスケジュール不可に
kubectl cordon node01

# 確認（SchedulingDisabled になる）
kubectl get nodes
# NAME     STATUS                     ROLES    AGE   VERSION
# node01   Ready,SchedulingDisabled   <none>   10d   v1.30.0

# 既存Podは動き続ける（重要！）
```

---

### drain（ノード排出）

```bash
# 基本コマンド
kubectl drain node01

# DaemonSetがあるとエラーになる → 無視オプション
kubectl drain node01 --ignore-daemonsets

# ローカルストレージを使うPodがあるとエラー → 強制削除
kubectl drain node01 --ignore-daemonsets --delete-emptydir-data

# コントローラ管理外のPodがあるとエラー → 強制
kubectl drain node01 --ignore-daemonsets --force

# 完全版（試験で使う）
kubectl drain node01 --ignore-daemonsets --delete-emptydir-data --force
```

### drainのオプション解説

| オプション | 説明 |
|-----------|------|
| `--ignore-daemonsets` | DaemonSetのPodを無視 |
| `--delete-emptydir-data` | emptyDirを使うPodを削除 |
| `--force` | コントローラ管理外のPodを削除 |
| `--grace-period=0` | 即座に削除 |
| `--timeout=300s` | タイムアウト設定 |

---

### uncordon（復帰）

```bash
# ノードをスケジュール可能に戻す
kubectl uncordon node01

# 確認
kubectl get nodes
# SchedulingDisabled が消える
```

---

## 2. Taint と Toleration

### 概念

```
Taint（汚染）: ノードに設定 → Podを寄せ付けない
Toleration（許容）: Podに設定 → Taintを許容してスケジュール可能に
```

### Taintの設定

```bash
# Taint追加
kubectl taint nodes node01 key=value:NoSchedule

# Taint確認
kubectl describe node node01 | grep Taint

# Taint削除（末尾に-をつける）
kubectl taint nodes node01 key=value:NoSchedule-

# または key だけで削除
kubectl taint nodes node01 key-
```

### Taint Effect（効果）

| Effect | 説明 |
|--------|------|
| `NoSchedule` | 新規Podをスケジュールしない |
| `PreferNoSchedule` | できれば避ける（ソフト） |
| `NoExecute` | 新規拒否 + 既存Podも退避 |

### Tolerationの設定（Pod側）

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  containers:
  - name: nginx
    image: nginx
  tolerations:
  - key: "key"
    operator: "Equal"
    value: "value"
    effect: "NoSchedule"
```

### operator の違い

```yaml
# Equal: key と value が完全一致
tolerations:
- key: "key"
  operator: "Equal"
  value: "value"
  effect: "NoSchedule"

# Exists: key が存在すればOK（valueは不要）
tolerations:
- key: "key"
  operator: "Exists"
  effect: "NoSchedule"

# 全てのTaintを許容
tolerations:
- operator: "Exists"
```

### コントロールプレーンのTaint

```bash
# コントロールプレーンにはデフォルトでTaintがある
kubectl describe node controlplane | grep Taint
# Taints: node-role.kubernetes.io/control-plane:NoSchedule

# このTaintを許容しないとコントロールプレーンにPodが配置されない
```

---

## 3. NodeSelector（シンプルなノード選択）

### ノードにラベル追加

```bash
kubectl label nodes node01 disktype=ssd
kubectl label nodes node02 disktype=hdd

# 確認
kubectl get nodes --show-labels
```

### PodでnodeSelector指定

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  containers:
  - name: nginx
    image: nginx
  nodeSelector:
    disktype: ssd  # このラベルを持つノードにスケジュール
```

---

## 4. Node Affinity（高度なノード選択）

### 種類

| 種類 | 説明 |
|------|------|
| `requiredDuringSchedulingIgnoredDuringExecution` | 必須（ハード） |
| `preferredDuringSchedulingIgnoredDuringExecution` | 優先（ソフト） |

### required（必須）の例

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  containers:
  - name: nginx
    image: nginx
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: disktype
            operator: In
            values:
            - ssd
            - nvme
```

### preferred（優先）の例

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  containers:
  - name: nginx
    image: nginx
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 1
        preference:
          matchExpressions:
          - key: disktype
            operator: In
            values:
            - ssd
```

### operator の種類

| Operator | 説明 |
|----------|------|
| `In` | いずれかの値に一致 |
| `NotIn` | いずれの値にも一致しない |
| `Exists` | キーが存在する |
| `DoesNotExist` | キーが存在しない |
| `Gt` | より大きい（数値） |
| `Lt` | より小さい（数値） |

---

## 5. nodeName（直接指定）

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  containers:
  - name: nginx
    image: nginx
  nodeName: node01  # スケジューラを完全にバイパス
```

**注意**: nodeNameを使うとスケジューラを通らないため、リソース制限も無視される。

---

## NodeSelector vs Node Affinity vs Taint/Toleration

| 機能 | 目的 | 強制力 |
|------|------|--------|
| NodeSelector | Podを特定ノードへ | 必須 |
| Node Affinity (required) | Podを特定ノードへ（複雑条件） | 必須 |
| Node Affinity (preferred) | Podを特定ノードへ（優先） | 優先 |
| Taint/Toleration | 特定Podだけノードを使用可能に | 排他 |

### 使い分け

```
「このPodはGPUノードで動かしたい」
→ NodeSelector または Node Affinity

「GPUノードはGPU Podだけ使いたい（他を排除）」
→ Taint + Toleration

「両方の条件を満たしたい」
→ Node Affinity + Taint/Toleration の組み合わせ
```

---

## 試験頻出パターン

### パターン1: メンテナンス手順

```bash
# 問題: node01をメンテナンスする

# 解答
kubectl drain node01 --ignore-daemonsets --force
# メンテナンス作業
kubectl uncordon node01
```

### パターン2: 特定ノードにPodを配置

```bash
# 問題: node01にだけPodを配置

# 解答1: nodeSelector
nodeSelector:
  kubernetes.io/hostname: node01

# 解答2: nodeName
nodeName: node01
```

### パターン3: コントロールプレーンにPod配置

```yaml
# コントロールプレーンのTaintを許容
tolerations:
- key: "node-role.kubernetes.io/control-plane"
  operator: "Exists"
  effect: "NoSchedule"
```

---

## 確認コマンド

```bash
# ノードの状態確認
kubectl get nodes

# ノードの詳細（Taint、Labels、Conditions）
kubectl describe node <node-name>

# ノードのラベル確認
kubectl get nodes --show-labels

# 特定ラベルのノード
kubectl get nodes -l disktype=ssd

# Taint確認
kubectl describe node <node-name> | grep -i taint
```

---

## ミニ演習（kind対応）

### 前提条件

multi-nodeのkindクラスタが必要です:

```bash
cat <<EOF > kind-config.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
- role: worker
EOF

kind create cluster --name cka --config kind-config.yaml
```

### 演習1: cordon/drain/uncordon

```bash
# ノード確認
kubectl get nodes

# Step 1: workerノードをcordon
kubectl cordon cka-worker

# 確認（SchedulingDisabled）
kubectl get nodes

# Step 2: テストPodを作成（どこに配置される？）
kubectl run test-pod --image=nginx

# 確認（cka-worker2に配置されるはず）
kubectl get pod test-pod -o wide

# Step 3: uncordon
kubectl uncordon cka-worker

# クリーンアップ
kubectl delete pod test-pod
```

### 演習2: Taint/Toleration

```bash
# Step 1: workerノードにTaintを追加
kubectl taint nodes cka-worker env=production:NoSchedule

# 確認
kubectl describe node cka-worker | grep Taint

# Step 2: Tolerationなしのpodを作成
kubectl run no-toleration --image=nginx

# 確認（cka-worker2に配置される）
kubectl get pod no-toleration -o wide

# Step 3: Tolerationありのpodを作成
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: with-toleration
spec:
  containers:
  - name: nginx
    image: nginx
  tolerations:
  - key: "env"
    operator: "Equal"
    value: "production"
    effect: "NoSchedule"
  nodeSelector:
    kubernetes.io/hostname: cka-worker
EOF

# 確認（cka-workerに配置される）
kubectl get pod with-toleration -o wide

# クリーンアップ
kubectl delete pod no-toleration with-toleration
kubectl taint nodes cka-worker env=production:NoSchedule-
```

### 演習3: NodeSelector

```bash
# Step 1: ノードにラベル追加
kubectl label nodes cka-worker disktype=ssd

# 確認
kubectl get nodes --show-labels | grep disktype

# Step 2: nodeSelectorでPod作成
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: ssd-pod
spec:
  containers:
  - name: nginx
    image: nginx
  nodeSelector:
    disktype: ssd
EOF

# 確認
kubectl get pod ssd-pod -o wide

# クリーンアップ
kubectl delete pod ssd-pod
kubectl label nodes cka-worker disktype-
```
