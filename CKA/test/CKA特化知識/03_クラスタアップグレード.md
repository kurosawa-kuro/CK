# CKA特化: クラスタアップグレード（kubeadm）

## 概要

kubeadmによるクラスタアップグレードは**CKA試験の頻出問題**。
手順を正確に暗記することが重要。

### 実技問題との対応

| 実技問題 | 使用する知識 |
|---------|------------|
| 問題1: ノードメンテナンス | drain/uncordon（アップグレード中のPod退避と同じ） |
| CKA試験 | kubeadm upgrade、apt-mark、systemctl |

**注意**: kindクラスタではkubeadm upgradeを実行できないため、理解確認とdrain/uncordon練習が中心

---

## アップグレードルール

### バージョンスキュー制限

```
kube-apiserver (x)
├── kube-controller-manager (x, x-1)
├── kube-scheduler (x, x-1)
├── kubelet (x, x-1, x-2)
└── kubectl (x+1, x, x-1)

重要: マイナーバージョンは1つずつアップグレード
例: 1.29 → 1.30 → 1.31 （1.29 → 1.31 は不可）
```

### アップグレード順序

```
1. コントロールプレーンノード（最初）
2. ワーカーノード（後から）

重要: 全てのノードを同時にアップグレードしない！
```

---

## コントロールプレーンのアップグレード

### Step 1: 利用可能なバージョン確認

```bash
# パッケージリストを更新
apt update

# 利用可能なkubeadmバージョン確認
apt-cache madison kubeadm

# 例: 1.30.0-00 が表示される
```

### Step 2: kubeadmのアップグレード

```bash
# kubeadmをアップグレード（バージョンを指定）
apt-mark unhold kubeadm
apt-get update && apt-get install -y kubeadm=1.30.0-00
apt-mark hold kubeadm

# バージョン確認
kubeadm version
```

### Step 3: アップグレードプラン確認

```bash
# アップグレード可能な内容を確認
kubeadm upgrade plan
```

### Step 4: コントロールプレーンのアップグレード実行

```bash
# 最初のコントロールプレーンノード
kubeadm upgrade apply v1.30.0

# 追加のコントロールプレーンノード（あれば）
kubeadm upgrade node
```

### Step 5: ノードをdrainする

```bash
# ノード名を確認
kubectl get nodes

# drainする
kubectl drain <node-name> --ignore-daemonsets
```

### Step 6: kubelet と kubectl のアップグレード

```bash
# kubelet と kubectl をアップグレード
apt-mark unhold kubelet kubectl
apt-get update && apt-get install -y kubelet=1.30.0-00 kubectl=1.30.0-00
apt-mark hold kubelet kubectl

# kubelet を再起動
systemctl daemon-reload
systemctl restart kubelet
```

### Step 7: ノードをuncordonする

```bash
kubectl uncordon <node-name>
```

---

## ワーカーノードのアップグレード

### Step 1: kubeadmのアップグレード（ワーカーノード上で実行）

```bash
apt-mark unhold kubeadm
apt-get update && apt-get install -y kubeadm=1.30.0-00
apt-mark hold kubeadm
```

### Step 2: kubelet設定のアップグレード

```bash
kubeadm upgrade node
```

### Step 3: ノードをdrainする（コントロールプレーンから）

```bash
kubectl drain <worker-node-name> --ignore-daemonsets
```

### Step 4: kubeletのアップグレード（ワーカーノード上で）

```bash
apt-mark unhold kubelet kubectl
apt-get update && apt-get install -y kubelet=1.30.0-00 kubectl=1.30.0-00
apt-mark hold kubelet kubectl

systemctl daemon-reload
systemctl restart kubelet
```

### Step 5: ノードをuncordonする（コントロールプレーンから）

```bash
kubectl uncordon <worker-node-name>
```

---

## 試験での手順まとめ

### コントロールプレーン（暗記用）

```bash
# 1. kubeadmアップグレード
apt-mark unhold kubeadm
apt-get update && apt-get install -y kubeadm=1.30.0-00
apt-mark hold kubeadm

# 2. アップグレード実行
kubeadm upgrade apply v1.30.0

# 3. ノードをdrain
kubectl drain <node> --ignore-daemonsets

# 4. kubelet/kubectlアップグレード
apt-mark unhold kubelet kubectl
apt-get update && apt-get install -y kubelet=1.30.0-00 kubectl=1.30.0-00
apt-mark hold kubelet kubectl
systemctl daemon-reload
systemctl restart kubelet

# 5. ノードをuncordon
kubectl uncordon <node>
```

### ワーカーノード（暗記用）

```bash
# 1. kubeadmアップグレード（ワーカーで）
apt-mark unhold kubeadm
apt-get update && apt-get install -y kubeadm=1.30.0-00
apt-mark hold kubeadm

# 2. kubelet設定更新（ワーカーで）
kubeadm upgrade node

# 3. drain（コントロールプレーンから）
kubectl drain <worker> --ignore-daemonsets

# 4. kubeletアップグレード（ワーカーで）
apt-mark unhold kubelet kubectl
apt-get update && apt-get install -y kubelet=1.30.0-00 kubectl=1.30.0-00
apt-mark hold kubelet kubectl
systemctl daemon-reload
systemctl restart kubelet

# 5. uncordon（コントロールプレーンから）
kubectl uncordon <worker>
```

---

## 重要コマンド比較

| コマンド | 使用場所 | 説明 |
|---------|---------|------|
| `kubeadm upgrade apply` | 最初のCP | コントロールプレーン全体 |
| `kubeadm upgrade node` | 追加CPまたはワーカー | ノード個別 |
| `kubectl drain` | どこからでも | ノードからPodを退避 |
| `kubectl uncordon` | どこからでも | ノードをスケジュール可能に |

---

## よくあるミスと対策

### ミス1: バージョン形式の間違い

```bash
# 間違い
kubeadm upgrade apply 1.30.0
apt install kubelet=1.30.0

# 正しい
kubeadm upgrade apply v1.30.0   # vが必要
apt install kubelet=1.30.0-00   # -00が必要
```

### ミス2: drain忘れ

```bash
# drainしないとPodが動き続ける
# アップグレード中にワークロードが中断する可能性

# 必ずdrainしてからアップグレード
kubectl drain <node> --ignore-daemonsets
```

### ミス3: systemctl忘れ

```bash
# kubeletインストール後に必ず実行
systemctl daemon-reload
systemctl restart kubelet
```

---

## 確認コマンド

```bash
# アップグレード後の確認
kubectl get nodes

# バージョン確認
kubectl version
kubeadm version
kubelet --version
```

---

## 試験Tips

### apt-mark について

```bash
# hold: パッケージを固定（自動更新を防ぐ）
apt-mark hold kubeadm kubelet kubectl

# unhold: 固定を解除（アップグレード可能に）
apt-mark unhold kubeadm kubelet kubectl

# 現在のhold状態確認
apt-mark showhold
```

### SSHでノード間移動

```bash
# ワーカーノードにSSH
ssh <worker-node-name>

# または
ssh node01

# 元に戻る
exit
```

---

## クイックリファレンス

```bash
# コントロールプレーン用（コピペ可）
apt-mark unhold kubeadm && apt-get update && apt-get install -y kubeadm=1.30.0-00 && apt-mark hold kubeadm
kubeadm upgrade apply v1.30.0
kubectl drain controlplane --ignore-daemonsets
apt-mark unhold kubelet kubectl && apt-get install -y kubelet=1.30.0-00 kubectl=1.30.0-00 && apt-mark hold kubelet kubectl
systemctl daemon-reload && systemctl restart kubelet
kubectl uncordon controlplane

# ワーカー用（コピペ可）
apt-mark unhold kubeadm && apt-get update && apt-get install -y kubeadm=1.30.0-00 && apt-mark hold kubeadm
kubeadm upgrade node
# (コントロールプレーンから) kubectl drain node01 --ignore-daemonsets
apt-mark unhold kubelet kubectl && apt-get install -y kubelet=1.30.0-00 kubectl=1.30.0-00 && apt-mark hold kubelet kubectl
systemctl daemon-reload && systemctl restart kubelet
# (コントロールプレーンから) kubectl uncordon node01
```

---

## ミニ演習（学習用）

kindではkubeadm upgradeを実行できないため、コマンドの学習と理解確認を行います。

### 演習1: 現在のバージョン確認

```bash
# kindクラスタで実行
kubectl get nodes
kubectl version --short
```

**確認ポイント:**
- 各ノードのVERSION列
- Client VersionとServer Version

### 演習2: コマンド順序の理解確認

以下の質問に答えてください:

1. **順序**: kubeadmとkubeletのアップグレード、どちらが先？
2. **drain**: kubeletアップグレードの前？後？
3. **apply vs node**: `kubeadm upgrade apply` と `kubeadm upgrade node` の違いは？

<details>
<summary>解答</summary>

1. kubeadmが先（kubeadm → kubelet）
2. 前（drain → kubeletアップグレード → uncordon）
3. applyは最初のcontrol-plane、nodeは追加CPまたはworker

</details>

### 演習3: コマンド書き取り練習

以下を紙に書いてみてください（暗記用）:

1. kubeadmを1.30.0にアップグレードするaptコマンド
2. control-planeをv1.30.0にアップグレードするkubeadmコマンド
3. kubelet再起動のsystemctlコマンド

<details>
<summary>解答</summary>

```bash
# 1
apt-mark unhold kubeadm && apt-get install -y kubeadm=1.30.0-00 && apt-mark hold kubeadm

# 2
kubeadm upgrade apply v1.30.0

# 3
systemctl daemon-reload && systemctl restart kubelet
```

</details>

詳細な手順は [docker-labs/upgrade-lab/README.md](../../docker-labs/upgrade-lab/README.md) を参照

---

## 段階的ハンズオン（実技問題への橋渡し）

kindクラスタではkubeadm upgradeを実行できませんが、drain/uncordonの動作と
コマンド順序の理解は問題1にも直結するため、しっかり練習しましょう。

### レベル1: 基礎（バージョン確認）

#### 演習1-1: 現在のバージョン確認

```bash
# kubectl version
kubectl version

# 各ノードのkubeletバージョン
kubectl get nodes

# 詳細なバージョン情報
kubectl get nodes -o custom-columns=NAME:.metadata.name,VERSION:.status.nodeInfo.kubeletVersion
```

**確認ポイント:**
- Client Version（kubectl）
- Server Version（API Server）
- 各ノードのVERSION列

#### 演習1-2: コンポーネントバージョン確認

```bash
# kubeadmバージョン（kind環境では確認方法が異なる）
docker exec cka-control-plane kubeadm version

# kubeletバージョン
docker exec cka-control-plane kubelet --version

# kubectlバージョン
docker exec cka-control-plane kubectl version --client
```

#### 演習1-3: apt-mark の理解確認

以下の質問に答えてください:

1. `apt-mark hold` は何のため？
2. `apt-mark unhold` はいつ使う？
3. `apt-mark showhold` の出力は？

<details>
<summary>解答</summary>

1. **apt-mark hold**: パッケージを固定して自動更新を防ぐ（意図しないアップグレードを防止）
2. **apt-mark unhold**: アップグレード前に固定を解除（インストール可能にする）
3. **apt-mark showhold**: 現在holdされているパッケージ一覧を表示

</details>

---

### レベル2: 応用（drain/uncordon練習）

#### 演習2-1: drain/uncordon の流れ（問題1の前段階）

```bash
# 準備: テストDeployment作成
kubectl create namespace upgrade-test
kubectl create deployment web --image=nginx --replicas=4 -n upgrade-test
sleep 5

# Pod配置確認
kubectl get pods -n upgrade-test -o wide

# === drain実行 ===
kubectl drain cka-worker --ignore-daemonsets --delete-emptydir-data

# 確認: Podが他ノードに移動
kubectl get pods -n upgrade-test -o wide

# ノードの状態確認（SchedulingDisabled）
kubectl get nodes

# === uncordon実行 ===
kubectl uncordon cka-worker

# 確認: SchedulingDisabledが消える
kubectl get nodes

# クリーンアップ
kubectl delete namespace upgrade-test
```

**理解ポイント:**
- drain = cordon + Pod退避
- uncordon後も既存Podは自動では戻らない

#### 演習2-2: アップグレード中のPod動作確認

```bash
# 準備
kubectl create namespace ha-test
kubectl create deployment ha-app --image=nginx --replicas=6 -n ha-test
sleep 5

# Pod配置確認（複数ノードに分散）
kubectl get pods -n ha-test -o wide

# === 1台目のworkerをdrain ===
kubectl drain cka-worker --ignore-daemonsets --delete-emptydir-data

# Pod配置確認（全Podがcka-worker2に）
echo "=== cka-worker drain後 ==="
kubectl get pods -n ha-test -o wide

# === 2台目のworkerをdrain（Podはどうなる？）===
kubectl drain cka-worker2 --ignore-daemonsets --delete-emptydir-data

# Pod配置確認（control-planeにTaintがあるためPending）
echo "=== cka-worker2 drain後 ==="
kubectl get pods -n ha-test -o wide

# === uncordon ===
kubectl uncordon cka-worker
kubectl uncordon cka-worker2

# 確認
kubectl get pods -n ha-test -o wide

# クリーンアップ
kubectl delete namespace ha-test
```

**理解ポイント:**
- 全workerをdrainするとPodがPendingになる
- control-planeにはTaintがあるため通常のPodは配置されない
- アップグレードは1ノードずつ行う理由がこれ

---

### レベル3: 実技問題準備

#### 演習3-1: アップグレード手順の書き取り

以下の手順を紙に書いてみてください:

**コントロールプレーンのアップグレード（5ステップ）**

<details>
<summary>解答</summary>

```bash
# 1. kubeadmアップグレード
apt-mark unhold kubeadm
apt-get update && apt-get install -y kubeadm=1.30.0-00
apt-mark hold kubeadm

# 2. アップグレード実行
kubeadm upgrade apply v1.30.0

# 3. ノードをdrain
kubectl drain <node> --ignore-daemonsets

# 4. kubelet/kubectlアップグレード
apt-mark unhold kubelet kubectl
apt-get install -y kubelet=1.30.0-00 kubectl=1.30.0-00
apt-mark hold kubelet kubectl
systemctl daemon-reload
systemctl restart kubelet

# 5. ノードをuncordon
kubectl uncordon <node>
```

</details>

**ワーカーノードのアップグレード（5ステップ）**

<details>
<summary>解答</summary>

```bash
# 1. kubeadmアップグレード（ワーカーで）
apt-mark unhold kubeadm
apt-get update && apt-get install -y kubeadm=1.30.0-00
apt-mark hold kubeadm

# 2. kubelet設定更新（ワーカーで）
kubeadm upgrade node

# 3. drain（コントロールプレーンから）
kubectl drain <worker> --ignore-daemonsets

# 4. kubeletアップグレード（ワーカーで）
apt-mark unhold kubelet kubectl
apt-get install -y kubelet=1.30.0-00 kubectl=1.30.0-00
apt-mark hold kubelet kubectl
systemctl daemon-reload
systemctl restart kubelet

# 5. uncordon（コントロールプレーンから）
kubectl uncordon <worker>
```

</details>

#### 演習3-2: コマンド違い確認

以下の違いを説明してください:

1. `kubeadm upgrade apply` vs `kubeadm upgrade node`
2. `apt install kubeadm=1.30.0-00` vs `kubeadm upgrade apply v1.30.0`
3. バージョン指定: `1.30.0-00` vs `v1.30.0`

<details>
<summary>解答</summary>

1. **apply vs node**
   - `apply`: 最初のコントロールプレーンで使用（クラスタ全体の設定を更新）
   - `node`: 追加CPまたはワーカーで使用（ノード単位の設定を更新）

2. **apt vs kubeadm**
   - `apt install`: パッケージをインストール
   - `kubeadm upgrade`: Kubernetesコンポーネントをアップグレード

3. **バージョン形式**
   - `1.30.0-00`: Debianパッケージバージョン（apt用）
   - `v1.30.0`: Kubernetesセマンティックバージョン（kubeadm用）

</details>

#### 演習3-3: トラブルシューティング理解

以下の状況の原因と対処を答えてください:

1. `kubeadm upgrade apply` で「version must be one minor higher」エラー
2. `apt install` で「kubeadm is not upgradable」エラー
3. アップグレード後にノードがNotReady

<details>
<summary>解答</summary>

1. **version must be one minor higher**
   - 原因: バージョンを2つ以上スキップしようとしている
   - 対処: 1.29 → 1.30 → 1.31 のように1つずつ

2. **kubeadm is not upgradable**
   - 原因: `apt-mark hold` で固定されている
   - 対処: `apt-mark unhold kubeadm` を先に実行

3. **ノードがNotReady**
   - 原因: kubeletが再起動されていない
   - 対処: `systemctl daemon-reload && systemctl restart kubelet`

</details>

---

## チートシート

### バージョン確認

```bash
# kubectl
kubectl version

# ノードバージョン
kubectl get nodes

# 詳細
kubectl get nodes -o custom-columns=NAME:.metadata.name,VERSION:.status.nodeInfo.kubeletVersion
```

### コントロールプレーンアップグレード（コピペ用）

```bash
# kubeadm
apt-mark unhold kubeadm && \
apt-get update && apt-get install -y kubeadm=1.30.0-00 && \
apt-mark hold kubeadm

# アップグレード実行
kubeadm upgrade apply v1.30.0

# drain
kubectl drain <node> --ignore-daemonsets

# kubelet/kubectl
apt-mark unhold kubelet kubectl && \
apt-get install -y kubelet=1.30.0-00 kubectl=1.30.0-00 && \
apt-mark hold kubelet kubectl
systemctl daemon-reload && systemctl restart kubelet

# uncordon
kubectl uncordon <node>
```

### ワーカーノードアップグレード（コピペ用）

```bash
# kubeadm（ワーカーで）
apt-mark unhold kubeadm && \
apt-get update && apt-get install -y kubeadm=1.30.0-00 && \
apt-mark hold kubeadm

# kubelet設定（ワーカーで）
kubeadm upgrade node

# drain（コントロールプレーンから）
kubectl drain <worker> --ignore-daemonsets

# kubelet（ワーカーで）
apt-mark unhold kubelet kubectl && \
apt-get install -y kubelet=1.30.0-00 kubectl=1.30.0-00 && \
apt-mark hold kubelet kubectl
systemctl daemon-reload && systemctl restart kubelet

# uncordon（コントロールプレーンから）
kubectl uncordon <worker>
```

### コマンド比較

| コマンド | 使用場所 | 説明 |
|---------|---------|------|
| `kubeadm upgrade apply` | 最初のCP | クラスタ全体 |
| `kubeadm upgrade node` | 追加CP/Worker | ノード単位 |
| `kubectl drain` | どこからでも | Pod退避 |
| `kubectl uncordon` | どこからでも | スケジュール再開 |

### バージョン形式

| 用途 | 形式 | 例 |
|-----|------|---|
| apt install | `X.Y.Z-00` | `1.30.0-00` |
| kubeadm upgrade | `vX.Y.Z` | `v1.30.0` |

### apt-mark コマンド

```bash
# 固定
apt-mark hold kubeadm kubelet kubectl

# 固定解除
apt-mark unhold kubeadm kubelet kubectl

# 確認
apt-mark showhold
```

### よくあるミス対処

| ミス | 対処 |
|-----|------|
| バージョン2つスキップ | 1つずつアップグレード |
| apt-mark unhold忘れ | unhold してから install |
| systemctl忘れ | daemon-reload && restart kubelet |
| vなしで kubeadm upgrade | v を付ける |
| -00なしで apt install | -00 を付ける |
