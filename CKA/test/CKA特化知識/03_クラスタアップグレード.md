# CKA特化: クラスタアップグレード（kubeadm）

## 概要

kubeadmによるクラスタアップグレードは**CKA試験の頻出問題**。
手順を正確に暗記することが重要。

---

## アップグレードルール

### バージョンスキュー制限

```
kube-apiserver (x)
├── kube-controller-manager (x, x-1)
├── kube-scheduler (x, x-1)
├── kubelet (x, x-1, x-2)
└── kubectl (x+1, x, x-1)

重要: マイナーバージョンは1つずつアップグレード
例: 1.29 → 1.30 → 1.31 （1.29 → 1.31 は不可）
```

### アップグレード順序

```
1. コントロールプレーンノード（最初）
2. ワーカーノード（後から）

重要: 全てのノードを同時にアップグレードしない！
```

---

## コントロールプレーンのアップグレード

### Step 1: 利用可能なバージョン確認

```bash
# パッケージリストを更新
apt update

# 利用可能なkubeadmバージョン確認
apt-cache madison kubeadm

# 例: 1.30.0-00 が表示される
```

### Step 2: kubeadmのアップグレード

```bash
# kubeadmをアップグレード（バージョンを指定）
apt-mark unhold kubeadm
apt-get update && apt-get install -y kubeadm=1.30.0-00
apt-mark hold kubeadm

# バージョン確認
kubeadm version
```

### Step 3: アップグレードプラン確認

```bash
# アップグレード可能な内容を確認
kubeadm upgrade plan
```

### Step 4: コントロールプレーンのアップグレード実行

```bash
# 最初のコントロールプレーンノード
kubeadm upgrade apply v1.30.0

# 追加のコントロールプレーンノード（あれば）
kubeadm upgrade node
```

### Step 5: ノードをdrainする

```bash
# ノード名を確認
kubectl get nodes

# drainする
kubectl drain <node-name> --ignore-daemonsets
```

### Step 6: kubelet と kubectl のアップグレード

```bash
# kubelet と kubectl をアップグレード
apt-mark unhold kubelet kubectl
apt-get update && apt-get install -y kubelet=1.30.0-00 kubectl=1.30.0-00
apt-mark hold kubelet kubectl

# kubelet を再起動
systemctl daemon-reload
systemctl restart kubelet
```

### Step 7: ノードをuncordonする

```bash
kubectl uncordon <node-name>
```

---

## ワーカーノードのアップグレード

### Step 1: kubeadmのアップグレード（ワーカーノード上で実行）

```bash
apt-mark unhold kubeadm
apt-get update && apt-get install -y kubeadm=1.30.0-00
apt-mark hold kubeadm
```

### Step 2: kubelet設定のアップグレード

```bash
kubeadm upgrade node
```

### Step 3: ノードをdrainする（コントロールプレーンから）

```bash
kubectl drain <worker-node-name> --ignore-daemonsets
```

### Step 4: kubeletのアップグレード（ワーカーノード上で）

```bash
apt-mark unhold kubelet kubectl
apt-get update && apt-get install -y kubelet=1.30.0-00 kubectl=1.30.0-00
apt-mark hold kubelet kubectl

systemctl daemon-reload
systemctl restart kubelet
```

### Step 5: ノードをuncordonする（コントロールプレーンから）

```bash
kubectl uncordon <worker-node-name>
```

---

## 試験での手順まとめ

### コントロールプレーン（暗記用）

```bash
# 1. kubeadmアップグレード
apt-mark unhold kubeadm
apt-get update && apt-get install -y kubeadm=1.30.0-00
apt-mark hold kubeadm

# 2. アップグレード実行
kubeadm upgrade apply v1.30.0

# 3. ノードをdrain
kubectl drain <node> --ignore-daemonsets

# 4. kubelet/kubectlアップグレード
apt-mark unhold kubelet kubectl
apt-get update && apt-get install -y kubelet=1.30.0-00 kubectl=1.30.0-00
apt-mark hold kubelet kubectl
systemctl daemon-reload
systemctl restart kubelet

# 5. ノードをuncordon
kubectl uncordon <node>
```

### ワーカーノード（暗記用）

```bash
# 1. kubeadmアップグレード（ワーカーで）
apt-mark unhold kubeadm
apt-get update && apt-get install -y kubeadm=1.30.0-00
apt-mark hold kubeadm

# 2. kubelet設定更新（ワーカーで）
kubeadm upgrade node

# 3. drain（コントロールプレーンから）
kubectl drain <worker> --ignore-daemonsets

# 4. kubeletアップグレード（ワーカーで）
apt-mark unhold kubelet kubectl
apt-get update && apt-get install -y kubelet=1.30.0-00 kubectl=1.30.0-00
apt-mark hold kubelet kubectl
systemctl daemon-reload
systemctl restart kubelet

# 5. uncordon（コントロールプレーンから）
kubectl uncordon <worker>
```

---

## 重要コマンド比較

| コマンド | 使用場所 | 説明 |
|---------|---------|------|
| `kubeadm upgrade apply` | 最初のCP | コントロールプレーン全体 |
| `kubeadm upgrade node` | 追加CPまたはワーカー | ノード個別 |
| `kubectl drain` | どこからでも | ノードからPodを退避 |
| `kubectl uncordon` | どこからでも | ノードをスケジュール可能に |

---

## よくあるミスと対策

### ミス1: バージョン形式の間違い

```bash
# 間違い
kubeadm upgrade apply 1.30.0
apt install kubelet=1.30.0

# 正しい
kubeadm upgrade apply v1.30.0   # vが必要
apt install kubelet=1.30.0-00   # -00が必要
```

### ミス2: drain忘れ

```bash
# drainしないとPodが動き続ける
# アップグレード中にワークロードが中断する可能性

# 必ずdrainしてからアップグレード
kubectl drain <node> --ignore-daemonsets
```

### ミス3: systemctl忘れ

```bash
# kubeletインストール後に必ず実行
systemctl daemon-reload
systemctl restart kubelet
```

---

## 確認コマンド

```bash
# アップグレード後の確認
kubectl get nodes

# バージョン確認
kubectl version
kubeadm version
kubelet --version
```

---

## 試験Tips

### apt-mark について

```bash
# hold: パッケージを固定（自動更新を防ぐ）
apt-mark hold kubeadm kubelet kubectl

# unhold: 固定を解除（アップグレード可能に）
apt-mark unhold kubeadm kubelet kubectl

# 現在のhold状態確認
apt-mark showhold
```

### SSHでノード間移動

```bash
# ワーカーノードにSSH
ssh <worker-node-name>

# または
ssh node01

# 元に戻る
exit
```

---

## クイックリファレンス

```bash
# コントロールプレーン用（コピペ可）
apt-mark unhold kubeadm && apt-get update && apt-get install -y kubeadm=1.30.0-00 && apt-mark hold kubeadm
kubeadm upgrade apply v1.30.0
kubectl drain controlplane --ignore-daemonsets
apt-mark unhold kubelet kubectl && apt-get install -y kubelet=1.30.0-00 kubectl=1.30.0-00 && apt-mark hold kubelet kubectl
systemctl daemon-reload && systemctl restart kubelet
kubectl uncordon controlplane

# ワーカー用（コピペ可）
apt-mark unhold kubeadm && apt-get update && apt-get install -y kubeadm=1.30.0-00 && apt-mark hold kubeadm
kubeadm upgrade node
# (コントロールプレーンから) kubectl drain node01 --ignore-daemonsets
apt-mark unhold kubelet kubectl && apt-get install -y kubelet=1.30.0-00 kubectl=1.30.0-00 && apt-mark hold kubelet kubectl
systemctl daemon-reload && systemctl restart kubelet
# (コントロールプレーンから) kubectl uncordon node01
```

---

## ミニ演習（学習用）

kindではkubeadm upgradeを実行できないため、コマンドの学習と理解確認を行います。

### 演習1: 現在のバージョン確認

```bash
# kindクラスタで実行
kubectl get nodes
kubectl version --short
```

**確認ポイント:**
- 各ノードのVERSION列
- Client VersionとServer Version

### 演習2: コマンド順序の理解確認

以下の質問に答えてください:

1. **順序**: kubeadmとkubeletのアップグレード、どちらが先？
2. **drain**: kubeletアップグレードの前？後？
3. **apply vs node**: `kubeadm upgrade apply` と `kubeadm upgrade node` の違いは？

<details>
<summary>解答</summary>

1. kubeadmが先（kubeadm → kubelet）
2. 前（drain → kubeletアップグレード → uncordon）
3. applyは最初のcontrol-plane、nodeは追加CPまたはworker

</details>

### 演習3: コマンド書き取り練習

以下を紙に書いてみてください（暗記用）:

1. kubeadmを1.30.0にアップグレードするaptコマンド
2. control-planeをv1.30.0にアップグレードするkubeadmコマンド
3. kubelet再起動のsystemctlコマンド

<details>
<summary>解答</summary>

```bash
# 1
apt-mark unhold kubeadm && apt-get install -y kubeadm=1.30.0-00 && apt-mark hold kubeadm

# 2
kubeadm upgrade apply v1.30.0

# 3
systemctl daemon-reload && systemctl restart kubelet
```

</details>

詳細な手順は [docker-labs/upgrade-lab/README.md](../../docker-labs/upgrade-lab/README.md) を参照
