# CKA特化: クラスタアーキテクチャとコンポーネント

## コントロールプレーン構成

```
┌─────────────────────────────────────────────────────────────┐
│                    Control Plane Node                        │
│  ┌─────────────┐  ┌──────────────────┐  ┌───────────────┐  │
│  │ kube-apiserver│  │kube-controller-  │  │kube-scheduler │  │
│  │              │  │    manager       │  │               │  │
│  └──────┬───────┘  └────────┬─────────┘  └───────┬───────┘  │
│         │                   │                     │          │
│         └───────────────────┼─────────────────────┘          │
│                             │                                │
│                       ┌─────▼─────┐                         │
│                       │   etcd    │                         │
│                       └───────────┘                         │
└─────────────────────────────────────────────────────────────┘
```

---

## 1. kube-apiserver

### 役割
- クラスタへの**唯一のエントリポイント**
- RESTful APIを提供
- 認証・認可・Admission Controlを実行
- etcdへの読み書きを担当

### 試験ポイント
```bash
# API Serverの確認
kubectl get pods -n kube-system | grep apiserver

# 静的Podのマニフェスト場所
/etc/kubernetes/manifests/kube-apiserver.yaml

# API Serverが停止すると
- kubectl コマンドが使えなくなる
- 新規リソース作成不可
- ただし既存Podは動き続ける（重要！）
```

### 主要フラグ（試験で見る）
| フラグ | 説明 |
|--------|------|
| `--etcd-servers` | etcdのエンドポイント |
| `--service-cluster-ip-range` | Service用のIP範囲 |
| `--client-ca-file` | クライアント証明書のCA |
| `--tls-cert-file` | API Serverの証明書 |

---

## 2. etcd

### 役割
- 分散Key-Valueストア
- クラスタの**全ての状態**を保存
- 唯一の永続的データストア

### 試験ポイント
```bash
# etcdの場所
/etc/kubernetes/manifests/etcd.yaml

# etcdに保存されるもの
- Pod, Deployment, Service等の定義
- ConfigMap, Secret
- RBAC設定
- Namespace

# etcdに保存されないもの（重要！）
- Node のリアルタイムメトリクス（CPU使用率等）
- コンテナログ
- ノード上の実行状態
```

### バックアップコマンド（必須暗記）
```bash
ETCDCTL_API=3 etcdctl snapshot save /backup/etcd-snapshot.db \
  --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key
```

---

## 3. kube-scheduler

### 役割
- Podをどのノードに配置するか決定
- **配置のみ**（起動はkubeletの仕事）

### スケジューリング判断基準
```yaml
# スケジューラが見るもの
- requests.cpu / requests.memory  # リソース要求
- nodeSelector                     # ノード選択
- nodeName                         # 直接指定
- taints/tolerations              # 排除条件
- affinity/anti-affinity          # 親和性

# スケジューラが見ないもの（重要！）
- limits.cpu / limits.memory      # これは起動後の制限
```

### Podがスケジュールされない理由
| 原因 | 状態 |
|------|------|
| リソース不足 | Pending (Insufficient cpu/memory) |
| taint不一致 | Pending (node(s) had taints) |
| nodeSelector不一致 | Pending (node(s) didn't match) |
| PVC未バインド | Pending (waiting for PVC) |

---

## 4. kube-controller-manager

### 役割
- 複数のコントローラを単一プロセスで実行
- Desired State と Actual State を一致させる

### 含まれるコントローラ
```
- Node Controller        : ノードの健全性監視
- Replication Controller : レプリカ数の維持
- Endpoints Controller   : Service-Podの紐付け
- ServiceAccount Controller : SA/Token生成
- Namespace Controller   : Namespace削除時のクリーンアップ
```

### 試験で問われる動作
```bash
# Node Controller の動作
- ノードの NotReady 判定
- node-monitor-period: 5s（ハートビート間隔）
- node-monitor-grace-period: 40s（許容時間）
- pod-eviction-timeout: 5m（Pod退避までの時間）

# controller-managerが停止すると
- レプリカ数が自動調整されない
- ノードのNotReady判定が行われない
- ただし既存Podは動き続ける
```

---

## 5. kubelet（ノードコンポーネント）

### 役割
- 各ノード上で動作
- API Serverからの指示でPodを起動
- コンテナランタイムと連携

### 試験ポイント
```bash
# kubeletの設定ファイル
/var/lib/kubelet/config.yaml

# kubeletのサービス
systemctl status kubelet
systemctl restart kubelet

# kubeletが停止すると
- ノードがNotReadyになる
- 新規Podがそのノードで起動しない
- 既存Podは動作を継続（コンテナランタイムが管理）
```

### 静的Pod
```bash
# 静的Podの定義場所
/etc/kubernetes/manifests/

# 静的Podの特徴
- kubeletが直接管理
- API Serverを経由しない
- ノード名がPod名に付与される
- コントロールプレーンのコンポーネントはこれで動作
```

---

## 6. kube-proxy（ノードコンポーネント）

### 役割
- Serviceの通信を実現
- iptables / IPVS ルールを管理

### 試験ポイント
```bash
# kube-proxyの動作モード
- iptables（デフォルト）
- IPVS（大規模クラスタ向け）

# kube-proxyが停止すると
- Service経由の通信ができなくなる
- Pod間の直接通信は可能
- ClusterIP, NodePortが機能しなくなる
```

---

## コンポーネント配置まとめ

| コンポーネント | 配置場所 | 管理方法 |
|---------------|---------|---------|
| kube-apiserver | Master | 静的Pod |
| etcd | Master | 静的Pod |
| kube-scheduler | Master | 静的Pod |
| kube-controller-manager | Master | 静的Pod |
| kubelet | 全ノード | systemd |
| kube-proxy | 全ノード | DaemonSet |

---

## 障害時の影響まとめ（試験頻出）

| 停止コンポーネント | 影響 |
|------------------|------|
| kube-apiserver | kubectl不可、新規作成不可、既存Pod継続 |
| etcd | 全ての書き込み不可 |
| kube-scheduler | 新規Podがスケジュールされない（Pending） |
| kube-controller-manager | レプリカ調整不可、NotReady判定不可 |
| kubelet | ノードNotReady、新規Pod起動不可 |
| kube-proxy | Service通信不可 |

---

## 確認コマンド集

```bash
# コントロールプレーンPodの確認
kubectl get pods -n kube-system

# コンポーネントの健全性
kubectl get componentstatuses  # 非推奨だが試験で出る可能性

# ノード状態
kubectl get nodes
kubectl describe node <node-name>

# 静的Podの確認
ls /etc/kubernetes/manifests/
```

---

## ミニ演習（kind対応）

### 演習1: コントロールプレーンコンポーネントの確認

```bash
# 環境準備（kindクラスタ起動済みの前提）
kubectl get pods -n kube-system
```

**やってみよう:**
1. kube-system名前空間のPodを一覧表示
2. 各コンポーネント（apiserver, scheduler, controller-manager, etcd）を特定
3. coredns, kube-proxy も確認

**確認コマンド:**
```bash
# コントロールプレーンのPod
kubectl get pods -n kube-system -l tier=control-plane

# 各コンポーネントの詳細
kubectl describe pod -n kube-system kube-apiserver-cka-control-plane
```

### 演習2: ノードコンポーネントの確認

```bash
# ノード情報
kubectl get nodes -o wide

# ノードの詳細（Conditions, Capacity確認）
kubectl describe node cka-control-plane
```

**確認ポイント:**
- Ready条件がTrueか
- kubeletバージョン
- Container Runtime

### 演習3: コンポーネント停止の影響（理解確認）

以下の質問に答えてください（実行不要）:

1. **kube-apiserver停止時**: kubectlは使える？既存Podは動く？
2. **kube-scheduler停止時**: 新規Podはどうなる？
3. **kubelet停止時**: そのノードのPodはどうなる？

<details>
<summary>解答</summary>

1. kubectlは使えない、既存Podは動き続ける
2. 新規PodはPendingになる（スケジュールされない）
3. 既存Podは動き続けるが、ノードはNotReadyになる

</details>
