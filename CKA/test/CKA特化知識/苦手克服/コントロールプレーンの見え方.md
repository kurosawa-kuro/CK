# コントロールプレーンコンポーネント vs ノードコンポーネント

## 最初の疑問
`kubectl get nodes -o wide` でコントロールプレーンが見えるのはなぜ？

→ **コントロールプレーンも「ノード」の1つだから**

## 混乱ポイント
「コントロールプレーン**ノード**」と「コントロールプレーン**コンポーネント**」は別物！

```
┌─────────────────────────────────────────────────────────────────┐
│                      Kubernetes Cluster                          │
│                                                                   │
│  ┌─────────────────────────────┐   ┌─────────────────────────┐  │
│  │   cka-control-plane         │   │      cka-worker         │  │
│  │   (ノード)                   │   │      (ノード)            │  │
│  │   ROLES: control-plane      │   │      ROLES: <none>       │  │
│  │                             │   │                          │  │
│  │  ┌───────────────────────┐  │   │                          │  │
│  │  │ コントロールプレーン   │  │   │                          │  │
│  │  │ コンポーネント (Pod)   │  │   │     User Pods           │  │
│  │  │  - etcd               │  │   │                          │  │
│  │  │  - kube-apiserver     │  │   │                          │  │
│  │  │  - kube-scheduler     │  │   │                          │  │
│  │  │  - controller-manager │  │   │                          │  │
│  │  └───────────────────────┘  │   │                          │  │
│  │                             │   │                          │  │
│  │  ┌───────────────────────┐  │   │  ┌────────────────────┐  │  │
│  │  │ ノードコンポーネント   │  │   │  │ノードコンポーネント │  │  │
│  │  │  - kubelet (systemd)  │  │   │  │ - kubelet (systemd)│  │  │
│  │  │  - kube-proxy (Pod)   │  │   │  │ - kube-proxy (Pod) │  │  │
│  │  └───────────────────────┘  │   │  └────────────────────┘  │  │
│  └─────────────────────────────┘   └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2種類のコンポーネント

### コントロールプレーンコンポーネント（4つ）
**配置:** コントロールプレーンノード上のみ
**管理方法:** 静的Pod（/etc/kubernetes/manifests/）

| コンポーネント | 役割 | 停止時の影響 |
|--------------|------|-------------|
| etcd | クラスタ状態の保存（Key-Value） | 全ての書き込み不可 |
| kube-apiserver | 全操作の入口（REST API） | kubectl不可、既存Podは継続 |
| kube-scheduler | Podの配置先を決定 | 新規PodがPendingのまま |
| kube-controller-manager | 各種コントローラ実行 | レプリカ調整されない |

### ノードコンポーネント（2つ）
**配置:** 全ノード（control-plane含む）
**重要:** コントロールプレーンノードにも存在する！

| コンポーネント | 役割 | 管理方法 | 停止時の影響 |
|--------------|------|---------|-------------|
| kubelet | Podの起動・監視 | systemd | ノードがNotReadyに |
| kube-proxy | Service通信の実現 | DaemonSet | Service経由の通信不可 |

---

## 確認コマンド対応表

| 見たいもの | コマンド |
|-----------|---------|
| 全ノード一覧 | `kubectl get nodes` |
| 全ノード詳細 | `kubectl get nodes -o wide` |
| コントロールプレーンコンポーネント | `kubectl get pods -n kube-system -l tier=control-plane` |
| ノードコンポーネント（kube-proxy） | `kubectl get pods -n kube-system -l k8s-app=kube-proxy` |
| kubelet状態 | `systemctl status kubelet` |
| kube-system全Pod | `kubectl get pods -n kube-system` |

---

## よくある誤解

### 誤解1: コントロールプレーンはノードじゃない
❌ 間違い
✅ コントロールプレーンも「ノード」の1種

### 誤解2: kubeletはワーカーノードだけ
❌ 間違い
✅ kubeletは全ノードで動作（コントロールプレーン含む）

### 誤解3: kube-proxyはワーカーノードだけ
❌ 間違い
✅ kube-proxyはDaemonSetなので全ノードで動作

---

## コンポーネント配置まとめ

| コンポーネント | control-plane | worker | 管理方法 |
|--------------|:-------------:|:------:|---------|
| etcd | ✅ | ❌ | 静的Pod |
| kube-apiserver | ✅ | ❌ | 静的Pod |
| kube-scheduler | ✅ | ❌ | 静的Pod |
| kube-controller-manager | ✅ | ❌ | 静的Pod |
| kubelet | ✅ | ✅ | systemd |
| kube-proxy | ✅ | ✅ | DaemonSet |

---

## 試験での確認手順

```bash
# 1. ノード確認（control-planeもworkerも見える）
kubectl get nodes -o wide

# 2. コントロールプレーンコンポーネント確認
kubectl get pods -n kube-system -l tier=control-plane

# 3. 全ノードで動くコンポーネント確認（DaemonSet）
kubectl get daemonset -n kube-system

# 4. kubelet確認（各ノードにSSHして）
systemctl status kubelet
```
