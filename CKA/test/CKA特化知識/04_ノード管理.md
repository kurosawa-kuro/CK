# CKA特化: ノード管理

## 概要

ノードのメンテナンス、スケジューリング制御はCKA試験の頻出領域。
drain/cordon/uncordon、Taint/Toleration、NodeAffinity を正確に理解する。

### 実技問題との対応

| 実技問題 | 使用する知識 |
|---------|------------|
| 問題1: ノードメンテナンス | cordon/drain/uncordon |
| 問題3: Taint/Toleration | Taint追加、Toleration付きPod |
| 問題4: DaemonSet | control-plane Taint許容 |
| 問題9: NodeSelector | ラベル付与、nodeSelector |

---

## 1. ノードのメンテナンス

### コマンド比較

| コマンド | 新規Pod | 既存Pod | 用途 |
|---------|--------|--------|------|
| `cordon` | ブロック | そのまま | スケジュール停止 |
| `drain` | ブロック | 退避 | メンテナンス準備 |
| `uncordon` | 許可 | - | 復帰 |

### 正しい手順（試験頻出）

```bash
# 1. スケジュール停止（新規Podが来ないように）
kubectl cordon <node-name>

# 2. 既存Podを退避
kubectl drain <node-name> --ignore-daemonsets

# 3. メンテナンス作業...

# 4. 復帰
kubectl uncordon <node-name>
```

---

### cordon（スケジュール停止）

```bash
# ノードをスケジュール不可に
kubectl cordon node01

# 確認（SchedulingDisabled になる）
kubectl get nodes
# NAME     STATUS                     ROLES    AGE   VERSION
# node01   Ready,SchedulingDisabled   <none>   10d   v1.30.0

# 既存Podは動き続ける（重要！）
```

---

### drain（ノード排出）

```bash
# 基本コマンド
kubectl drain node01

# DaemonSetがあるとエラーになる → 無視オプション
kubectl drain node01 --ignore-daemonsets

# ローカルストレージを使うPodがあるとエラー → 強制削除
kubectl drain node01 --ignore-daemonsets --delete-emptydir-data

# コントローラ管理外のPodがあるとエラー → 強制
kubectl drain node01 --ignore-daemonsets --force

# 完全版（試験で使う）
kubectl drain node01 --ignore-daemonsets --delete-emptydir-data --force
```

### drainのオプション解説

| オプション | 説明 |
|-----------|------|
| `--ignore-daemonsets` | DaemonSetのPodを無視 |
| `--delete-emptydir-data` | emptyDirを使うPodを削除 |
| `--force` | コントローラ管理外のPodを削除 |
| `--grace-period=0` | 即座に削除 |
| `--timeout=300s` | タイムアウト設定 |

---

### uncordon（復帰）

```bash
# ノードをスケジュール可能に戻す
kubectl uncordon node01

# 確認
kubectl get nodes
# SchedulingDisabled が消える
```

---

## 2. Taint と Toleration

### 概念

```
Taint（汚染）: ノードに設定 → Podを寄せ付けない
Toleration（許容）: Podに設定 → Taintを許容してスケジュール可能に
```

### Taintの設定

```bash
# Taint追加
kubectl taint nodes node01 key=value:NoSchedule

# Taint確認
kubectl describe node node01 | grep Taint

# Taint削除（末尾に-をつける）
kubectl taint nodes node01 key=value:NoSchedule-

# または key だけで削除
kubectl taint nodes node01 key-
```

### Taint Effect（効果）

| Effect | 説明 |
|--------|------|
| `NoSchedule` | 新規Podをスケジュールしない |
| `PreferNoSchedule` | できれば避ける（ソフト） |
| `NoExecute` | 新規拒否 + 既存Podも退避 |

### Tolerationの設定（Pod側）

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  containers:
  - name: nginx
    image: nginx
  tolerations:
  - key: "key"
    operator: "Equal"
    value: "value"
    effect: "NoSchedule"
```

### operator の違い

```yaml
# Equal: key と value が完全一致
tolerations:
- key: "key"
  operator: "Equal"
  value: "value"
  effect: "NoSchedule"

# Exists: key が存在すればOK（valueは不要）
tolerations:
- key: "key"
  operator: "Exists"
  effect: "NoSchedule"

# 全てのTaintを許容
tolerations:
- operator: "Exists"
```

### コントロールプレーンのTaint

```bash
# コントロールプレーンにはデフォルトでTaintがある
kubectl describe node controlplane | grep Taint
# Taints: node-role.kubernetes.io/control-plane:NoSchedule

# このTaintを許容しないとコントロールプレーンにPodが配置されない
```

---

## 3. NodeSelector（シンプルなノード選択）

### ノードにラベル追加

```bash
kubectl label nodes node01 disktype=ssd
kubectl label nodes node02 disktype=hdd

# 確認
kubectl get nodes --show-labels
```

### PodでnodeSelector指定

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  containers:
  - name: nginx
    image: nginx
  nodeSelector:
    disktype: ssd  # このラベルを持つノードにスケジュール
```

---

## 4. Node Affinity（高度なノード選択）

### 種類

| 種類 | 説明 |
|------|------|
| `requiredDuringSchedulingIgnoredDuringExecution` | 必須（ハード） |
| `preferredDuringSchedulingIgnoredDuringExecution` | 優先（ソフト） |

### required（必須）の例

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  containers:
  - name: nginx
    image: nginx
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: disktype
            operator: In
            values:
            - ssd
            - nvme
```

### preferred（優先）の例

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  containers:
  - name: nginx
    image: nginx
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 1
        preference:
          matchExpressions:
          - key: disktype
            operator: In
            values:
            - ssd
```

### operator の種類

| Operator | 説明 |
|----------|------|
| `In` | いずれかの値に一致 |
| `NotIn` | いずれの値にも一致しない |
| `Exists` | キーが存在する |
| `DoesNotExist` | キーが存在しない |
| `Gt` | より大きい（数値） |
| `Lt` | より小さい（数値） |

---

## 5. nodeName（直接指定）

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  containers:
  - name: nginx
    image: nginx
  nodeName: node01  # スケジューラを完全にバイパス
```

**注意**: nodeNameを使うとスケジューラを通らないため、リソース制限も無視される。

---

## NodeSelector vs Node Affinity vs Taint/Toleration

| 機能 | 目的 | 強制力 |
|------|------|--------|
| NodeSelector | Podを特定ノードへ | 必須 |
| Node Affinity (required) | Podを特定ノードへ（複雑条件） | 必須 |
| Node Affinity (preferred) | Podを特定ノードへ（優先） | 優先 |
| Taint/Toleration | 特定Podだけノードを使用可能に | 排他 |

### 使い分け

```
「このPodはGPUノードで動かしたい」
→ NodeSelector または Node Affinity

「GPUノードはGPU Podだけ使いたい（他を排除）」
→ Taint + Toleration

「両方の条件を満たしたい」
→ Node Affinity + Taint/Toleration の組み合わせ
```

---

## 試験頻出パターン

### パターン1: メンテナンス手順

```bash
# 問題: node01をメンテナンスする

# 解答
kubectl drain node01 --ignore-daemonsets --force
# メンテナンス作業
kubectl uncordon node01
```

### パターン2: 特定ノードにPodを配置

```bash
# 問題: node01にだけPodを配置

# 解答1: nodeSelector
nodeSelector:
  kubernetes.io/hostname: node01

# 解答2: nodeName
nodeName: node01
```

### パターン3: コントロールプレーンにPod配置

```yaml
# コントロールプレーンのTaintを許容
tolerations:
- key: "node-role.kubernetes.io/control-plane"
  operator: "Exists"
  effect: "NoSchedule"
```

---

## 確認コマンド

```bash
# ノードの状態確認
kubectl get nodes

# ノードの詳細（Taint、Labels、Conditions）
kubectl describe node <node-name>

# ノードのラベル確認
kubectl get nodes --show-labels

# 特定ラベルのノード
kubectl get nodes -l disktype=ssd

# Taint確認
kubectl describe node <node-name> | grep -i taint
```

---

## ミニ演習（kind対応）

### 前提条件

multi-nodeのkindクラスタが必要です:

```bash
cat <<EOF > kind-config.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
- role: worker
EOF

kind create cluster --name cka --config kind-config.yaml
```

### 演習1: cordon/drain/uncordon

```bash
# ノード確認
kubectl get nodes

# Step 1: workerノードをcordon
kubectl cordon cka-worker

# 確認（SchedulingDisabled）
kubectl get nodes

# Step 2: テストPodを作成（どこに配置される？）
kubectl run test-pod --image=nginx

# 確認（cka-worker2に配置されるはず）
kubectl get pod test-pod -o wide

# Step 3: uncordon
kubectl uncordon cka-worker

# クリーンアップ
kubectl delete pod test-pod
```

### 演習2: Taint/Toleration

```bash
# Step 1: workerノードにTaintを追加
kubectl taint nodes cka-worker env=production:NoSchedule

# 確認
kubectl describe node cka-worker | grep Taint

# Step 2: Tolerationなしのpodを作成
kubectl run no-toleration --image=nginx

# 確認（cka-worker2に配置される）
kubectl get pod no-toleration -o wide

# Step 3: Tolerationありのpodを作成
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: with-toleration
spec:
  containers:
  - name: nginx
    image: nginx
  tolerations:
  - key: "env"
    operator: "Equal"
    value: "production"
    effect: "NoSchedule"
  nodeSelector:
    kubernetes.io/hostname: cka-worker
EOF

# 確認（cka-workerに配置される）
kubectl get pod with-toleration -o wide

# クリーンアップ
kubectl delete pod no-toleration with-toleration
kubectl taint nodes cka-worker env=production:NoSchedule-
```

### 演習3: NodeSelector

```bash
# Step 1: ノードにラベル追加
kubectl label nodes cka-worker disktype=ssd

# 確認
kubectl get nodes --show-labels | grep disktype

# Step 2: nodeSelectorでPod作成
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: ssd-pod
spec:
  containers:
  - name: nginx
    image: nginx
  nodeSelector:
    disktype: ssd
EOF

# 確認
kubectl get pod ssd-pod -o wide

# クリーンアップ
kubectl delete pod ssd-pod
kubectl label nodes cka-worker disktype-
```

---

## 段階的ハンズオン（実技問題への橋渡し）

### レベル1: 基礎（単一コマンド）

以下の演習を**個別に**実行して、各コマンドの動作を確認してください。

#### 演習1-1: cordon/uncordon の基本

```bash
# 準備: ノード確認
kubectl get nodes

# 1. cordon でスケジュール停止
kubectl cordon cka-worker

# 確認: SchedulingDisabled が表示される
kubectl get nodes

# 2. テストPodを作成（どこに配置される？）
kubectl run test-cordon --image=nginx

# 確認: cka-worker以外に配置される
kubectl get pod test-cordon -o wide

# 3. uncordon で復帰
kubectl uncordon cka-worker

# 確認: SchedulingDisabled が消える
kubectl get nodes

# クリーンアップ
kubectl delete pod test-cordon
```

**理解ポイント:**
- `cordon` は既存Podに影響しない
- `uncordon` 後も既存Podは自動で戻らない

#### 演習1-2: Taint の追加と削除

```bash
# 1. Taint を追加
kubectl taint nodes cka-worker test-key=test-value:NoSchedule

# 確認
kubectl describe node cka-worker | grep Taint

# 2. テストPod作成（スケジュールされない or 他ノードへ）
kubectl run test-taint --image=nginx

# 確認
kubectl get pod test-taint -o wide

# 3. Taint を削除（末尾の - に注意）
kubectl taint nodes cka-worker test-key=test-value:NoSchedule-

# 確認
kubectl describe node cka-worker | grep Taint

# クリーンアップ
kubectl delete pod test-taint
```

**理解ポイント:**
- Taint削除は `key=value:effect-` の形式
- `NoSchedule` は既存Podに影響しない

#### 演習1-3: ラベルの追加と削除

```bash
# 1. ラベルを追加
kubectl label nodes cka-worker env=production

# 確認
kubectl get nodes cka-worker --show-labels | grep env

# 2. 特定ラベルを持つノード一覧
kubectl get nodes -l env=production

# 3. ラベルを削除（末尾の - に注意）
kubectl label nodes cka-worker env-

# 確認
kubectl get nodes -l env=production
# 結果が空になる
```

**理解ポイント:**
- ラベル削除は `key-` の形式
- `-l` でフィルタリング可能

---

### レベル2: 応用（組み合わせ）

#### 演習2-1: drain + uncordon の流れ

```bash
# 準備: テスト用Deployment作成
kubectl create namespace drain-test
kubectl create deployment web --image=nginx --replicas=3 -n drain-test

# Pod配置確認
kubectl get pods -n drain-test -o wide

# 1. drain実行
kubectl drain cka-worker --ignore-daemonsets --delete-emptydir-data

# 確認: Podが他ノードに移動
kubectl get pods -n drain-test -o wide

# 2. uncordon で復帰
kubectl uncordon cka-worker

# 確認: 新規Podはまだcka-workerに配置されない（既存で足りているため）
kubectl get pods -n drain-test -o wide

# 3. スケールアップして確認
kubectl scale deployment web --replicas=6 -n drain-test

# 確認: 新規Podはcka-workerにも配置される
kubectl get pods -n drain-test -o wide

# クリーンアップ
kubectl delete namespace drain-test
```

**理解ポイント:**
- `drain` は `cordon` + Pod退避
- uncordon後、既存Podは自動で戻らない
- 新規Podは両ノードに分散する

#### 演習2-2: Taint + Toleration のセット

```bash
# 準備
kubectl create namespace taint-test

# 1. Taint を追加
kubectl taint nodes cka-worker dedicated=special:NoSchedule

# 2. Tolerationなし Pod（他ノードに配置）
kubectl run no-toleration --image=nginx -n taint-test

# 確認
kubectl get pod no-toleration -n taint-test -o wide

# 3. Tolerationあり Pod（cka-workerに配置可能）
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: with-toleration
  namespace: taint-test
spec:
  containers:
  - name: nginx
    image: nginx
  tolerations:
  - key: "dedicated"
    operator: "Equal"
    value: "special"
    effect: "NoSchedule"
  nodeSelector:
    kubernetes.io/hostname: cka-worker
EOF

# 確認
kubectl get pod with-toleration -n taint-test -o wide

# クリーンアップ
kubectl delete namespace taint-test
kubectl taint nodes cka-worker dedicated=special:NoSchedule-
```

**理解ポイント:**
- Toleration だけでは「配置可能」になるだけ
- 確実に配置するには `nodeSelector` も使う

#### 演習2-3: NodeSelector + ラベル のセット

```bash
# 準備
kubectl create namespace label-test

# 1. ラベル付与前にPod作成（Pendingになる）
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: pending-pod
  namespace: label-test
spec:
  containers:
  - name: nginx
    image: nginx
  nodeSelector:
    gpu: "true"
EOF

# 確認: Pendingになる
kubectl get pod pending-pod -n label-test
kubectl describe pod pending-pod -n label-test | grep -A 5 Events

# 2. ラベルを付与
kubectl label nodes cka-worker gpu=true

# 確認: Runningになる
kubectl get pod pending-pod -n label-test -o wide

# クリーンアップ
kubectl delete namespace label-test
kubectl label nodes cka-worker gpu-
```

**理解ポイント:**
- nodeSelectorに一致するラベルがないとPendingになる
- ラベルを付与すると自動でスケジュールされる

---

### レベル3: 実技問題準備

#### 演習3-1: 問題1シミュレーション（ノードメンテナンス）

```bash
# 環境準備
kubectl create namespace maintenance
kubectl create deployment web-app --image=nginx --replicas=3 -n maintenance
kubectl create deployment api-app --image=nginx --replicas=2 -n maintenance
sleep 5

# 現状確認
kubectl get pods -n maintenance -o wide

# === 問題開始 ===
# タスク: cka-worker をメンテナンスする

# Step 1: スケジュール停止
kubectl cordon cka-worker

# Step 2: Pod退避
kubectl drain cka-worker --ignore-daemonsets --delete-emptydir-data --force

# Step 3: (メンテナンス作業をシミュレート)
echo "メンテナンス中..."

# Step 4: 復帰
kubectl uncordon cka-worker

# === 確認 ===
kubectl get nodes
kubectl get pods -n maintenance -o wide

# クリーンアップ
kubectl delete namespace maintenance
```

#### 演習3-2: 問題3シミュレーション（Taint + Toleration）

```bash
# 環境準備
kubectl create namespace taint-sim

# === 問題開始 ===
# タスク1: Taint追加
kubectl taint nodes cka-worker dedicated=critical:NoSchedule

# タスク2: Toleration付きPod作成
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: critical-pod
  namespace: taint-sim
spec:
  containers:
  - name: nginx
    image: nginx:alpine
  tolerations:
  - key: "dedicated"
    operator: "Equal"
    value: "critical"
    effect: "NoSchedule"
  nodeSelector:
    kubernetes.io/hostname: cka-worker
EOF

# === 確認 ===
kubectl get pod critical-pod -n taint-sim -o wide
# NODE列がcka-workerであることを確認

# クリーンアップ
kubectl delete namespace taint-sim
kubectl taint nodes cka-worker dedicated=critical:NoSchedule-
```

#### 演習3-3: 問題4シミュレーション（control-plane Taint許容）

```bash
# 環境準備
kubectl create namespace ds-test

# DaemonSet作成（control-planeには配置されない）
cat <<EOF | kubectl apply -f -
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: test-ds
  namespace: ds-test
spec:
  selector:
    matchLabels:
      name: test-ds
  template:
    metadata:
      labels:
        name: test-ds
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
EOF

# 確認: control-planeにはPodがない
kubectl get pods -n ds-test -o wide

# === 問題開始 ===
# タスク: control-planeでもPodを実行させる

# DaemonSetを編集してTolerationを追加
kubectl patch daemonset test-ds -n ds-test --type='json' -p='[
  {
    "op": "add",
    "path": "/spec/template/spec/tolerations",
    "value": [
      {
        "key": "node-role.kubernetes.io/control-plane",
        "operator": "Exists",
        "effect": "NoSchedule"
      }
    ]
  }
]'

# === 確認 ===
kubectl get pods -n ds-test -o wide
# 全ノード（control-plane含む）にPodがあることを確認

# クリーンアップ
kubectl delete namespace ds-test
```

#### 演習3-4: 問題9シミュレーション（NodeSelector + ラベル）

```bash
# 環境準備
kubectl create namespace placement

# nodeSelectorありPod作成（Pendingになる）
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: gpu-pod
  namespace: placement
spec:
  containers:
  - name: nginx
    image: nginx:alpine
  nodeSelector:
    gpu: "true"
    zone: us-west-1a
EOF

# 確認: Pending
kubectl get pod gpu-pod -n placement
kubectl describe pod gpu-pod -n placement | grep -A 3 Events

# === 問題開始 ===
# タスク: ラベルを付与してPodを実行させる

kubectl label nodes cka-worker gpu=true zone=us-west-1a

# === 確認 ===
kubectl get pod gpu-pod -n placement -o wide
# Runningになり、cka-workerに配置されることを確認

# クリーンアップ
kubectl delete namespace placement
kubectl label nodes cka-worker gpu- zone-
```

---

## チートシート

### drain/cordon/uncordon

```bash
# スケジュール停止
kubectl cordon <node>

# Pod退避（完全版）
kubectl drain <node> --ignore-daemonsets --delete-emptydir-data --force

# 復帰
kubectl uncordon <node>
```

### Taint

```bash
# 追加
kubectl taint nodes <node> key=value:NoSchedule

# 確認
kubectl describe node <node> | grep Taint

# 削除（末尾に-）
kubectl taint nodes <node> key=value:NoSchedule-
```

### ラベル

```bash
# 追加
kubectl label nodes <node> key=value

# 確認
kubectl get nodes --show-labels
kubectl get nodes -l key=value

# 削除（末尾に-）
kubectl label nodes <node> key-
```

### Toleration テンプレート

```yaml
# Equal演算子（key, value, effect全て一致）
tolerations:
- key: "key"
  operator: "Equal"
  value: "value"
  effect: "NoSchedule"

# Exists演算子（keyが存在すればOK）
tolerations:
- key: "key"
  operator: "Exists"
  effect: "NoSchedule"

# control-plane許容（問題4で使用）
tolerations:
- key: "node-role.kubernetes.io/control-plane"
  operator: "Exists"
  effect: "NoSchedule"

# 全てのTaintを許容
tolerations:
- operator: "Exists"
```

### NodeSelector テンプレート

```yaml
nodeSelector:
  key: value
  # または
  kubernetes.io/hostname: <node-name>
```
