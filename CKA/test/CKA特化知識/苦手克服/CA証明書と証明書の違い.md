# CA証明書（cacert）と証明書（cert）の違い

## 概要

etcdctlコマンドで使う `--cacert`、`--cert`、`--key` の違いを理解する。

---

## わかりやすい例え：身分証明の仕組み

```
CA（認証局）= 「市役所」（身分証を発行する機関）
CA証明書    = 「市役所の印鑑」（この印鑑があれば本物とわかる）
証明書      = 「あなたの身分証明書」（市役所の印鑑が押されている）
秘密鍵      = 「あなただけが持つ暗証番号」
```

---

## etcdctlでの役割

```
--cacert (CA証明書)
  └─ 「相手が本物か確認するため」に使う
  └─ etcdサーバーの証明書が信頼できるCAから発行されたか検証

--cert (クライアント証明書)
  └─ 「自分が本物だと証明するため」に使う
  └─ etcdサーバーに「私は正規のクライアントです」と示す

--key (秘密鍵)
  └─ 証明書とペア。自分だけが持つ
  └─ 証明書が本当に自分のものだと証明する
```

---

## 図解：相互認証（mTLS）の流れ

```
┌────────────────┐                    ┌────────────────┐
│  etcdctl       │                    │  etcd サーバー  │
│  (クライアント) │                    │                │
└───────┬────────┘                    └───────┬────────┘
        │                                     │
        │  1. 接続要求                        │
        │────────────────────────────────────>│
        │                                     │
        │  2. サーバー証明書を提示             │
        │<────────────────────────────────────│
        │                                     │
  ┌─────┴─────┐                               │
  │ --cacert  │ CA証明書で                    │
  │ で検証    │ 「本物のetcdサーバーか？」      │
  └─────┬─────┘                               │
        │                                     │
        │  3. クライアント証明書を提示         │
        │     (--cert + --key)                │
        │────────────────────────────────────>│
        │                           ┌─────────┴─────────┐
        │                           │ サーバー側のCAで   │
        │                           │「正規クライアント？」│
        │                           └─────────┬─────────┘
        │                                     │
        │  4. 相互認証完了！通信開始           │
        │<───────────────────────────────────>│
```

---

## etcdの証明書ファイル

```
/etc/kubernetes/pki/etcd/
├── ca.crt      → --cacert   「信頼の基準」（CAの証明書）
├── server.crt  → --cert     「自分の身分証」（クライアント証明書）
└── server.key  → --key      「自分だけの秘密鍵」
```

---

## オプション早見表

| オプション | 目的 | 例え |
|-----------|------|------|
| `--cacert` | 相手を信頼するため | 「この印鑑は市役所の本物？」 |
| `--cert` | 自分を証明するため | 「私の身分証を見てください」 |
| `--key` | 身分証が自分のものと証明 | 「暗証番号も一致します」 |

---

## 試験での覚え方

**3つセットで使う**
- `cacert` = 相手確認（CA = Certificate Authority = 認証局）
- `cert` + `key` = 自分証明（証明書と秘密鍵はペア）

---

## 実際のコマンド例

```bash
ETCDCTL_API=3 etcdctl snapshot save /backup/snapshot.db \
  --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \   # 相手を信頼
  --cert=/etc/kubernetes/pki/etcd/server.crt \ # 自分を証明
  --key=/etc/kubernetes/pki/etcd/server.key    # 秘密鍵
```

---

## 補足：なぜ相互認証が必要？

Kubernetesクラスタでは、etcdに**全クラスタ情報**が保存されている。

- Secrets（パスワード、トークン）
- ConfigMaps
- Pod/Deployment定義
- etc...

**不正アクセスを防ぐため**、双方向で認証（mTLS: mutual TLS）が必要。

```
クライアント → サーバー: 「本物のetcd？」（cacertで検証）
サーバー → クライアント: 「正規の管理者？」（cert+keyで検証）
```

---

## よくある混乱ポイント

### Q: server.crtなのにクライアント証明書として使うの？

A: Kubernetesのetcd設定では、同じ証明書がサーバー・クライアント両方で使われることが多い。
名前に惑わされず、「自分を証明するもの」と理解する。

### Q: CA証明書は誰が作った？

A: kubeadmが`kubeadm init`時に自動生成。
`/etc/kubernetes/pki/etcd/ca.crt`と`ca.key`のペアで、
このCAが他の証明書（server.crtなど）に署名している。

---

## 関連ドキュメント

- [02_etcdバックアップ・リストア.md](../02_etcdバックアップ・リストア.md)
